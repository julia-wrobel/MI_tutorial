---
title: "Statistical image processing: segmentation, phenotyping, and normalization"
output:
  html_document: 
    toc: true
    toc_float: true
---



```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

```




## Slide Deck

<iframe class="speakerdeck-iframe" frameborder="0" src="https://speakerdeck.com/player/19588e79e83146a8bc844ed2f335c79e" title="MI_intro" allowfullscreen="true" style="border: 0px; background: padding-box padding-box rgba(0, 0, 0, 0.1); margin: 0px; padding: 0px; border-radius: 6px; box-shadow: rgba(0, 0, 0, 0.2) 0px 5px 40px; width: 100%; height: auto; aspect-ratio: 560 / 314;" data-ratio="1.78343949044586"></iframe>


## Normalization

As an illustrative example will use the `mxnorm` package to normalize the lung data. 

### Setting up `mx_dataset` object

 Use `slide_id` as slide identifier
- Use `sample_id` as image identifier
- Use the following marker columns:
    - `cd19`
    - `cd14`
    - `cd3`
    - `cd8`
    - `hladr`
    - `ck`
    - `dapi`
- Use `tissue_category` as a metadata column


```{r}

mx_data = mx_dataset(data = cell_level_lung,
                     slide_id = "slide_id",
                     image_id = "sample_id",
                     marker_cols = c("cd19",
                                     "cd3",
                                     "cd14",
                                     "cd8",
                                     "hladr",
                                     "ck",
                                     "dapi"
                                     ),
                     metadata_cols = c("tissue_category", "phenotype_ck", "phenotype_cd8", "phenotype_cd14",
                                       "phenotype_other", "phenotype_cd19"))



summary(mx_data)
```


And let's look at the data object we're going to use going forward:

```{r}
knitr::kable(head(mx_data$data))  %>%
    kableExtra::kable_styling() %>% kableExtra::scroll_box(width = "100%")
```


### Normalize using `mx_normalize()`

Normalize using two methods: `log10`, and `mean_divide`. Then, calculate Otsu discordance metrics.



```{r mxnorm, cache = TRUE}
mx_norm = mx_normalize(mx_data,
                       transform = "log10_mean_divide",
                       method = "None")


# Otsu
mx_norm = run_otsu_discordance(mx_norm,
                            table="both",
                            thresold_override=NULL,
                            plot_out = FALSE)

# umap
mx_norm = run_reduce_umap(mx_norm,
                          table="both",
                          marker_list = mx_data$marker_cols,
                          downsample_pct = .1,
                          metadata_cols = mx_data$metadata_cols)

```


Summary table that calculates the metrics from the Bioinformatics paper is printed below

```{r mxnorm_stats, cache = TRUE}
# calculate metrics for unnormalized and normalized data
summary(mx_norm)
```

### Plotting

First, density plots. Only showing density plots for unnormalized cells for two types of immune markers and 3 subjects.

```{r density_mxnorm, cache = TRUE}
set.seed(103001)
ids = sample(unique(cell_level_lung$slide_id), 3)
markers = c("cd19", "cd14")
mx_df = mx_data$data %>%
  pivot_longer(cd19:dapi, names_to = "marker", values_to = "marker_value") %>%
  filter(slide_id %in% ids)
  
  
cd14 = mx_df %>% 
    filter(marker %in% c("cd14")) %>%
    ggplot() +
  geom_line(stat = "density", aes(marker_value, group = sample_id, color = slide_id), 
            alpha=0.5, linetype = 2) +
    geom_density(aes(marker_value, group = slide_id,
                   color = slide_id), size = 1.25) +
  scale_color_viridis(discrete = TRUE) +
  facet_wrap(~marker, scales = "free", ncol = 1) +
  theme(legend.position = "none") +
  xlim(0, 1) +
  labs(x = "")


cd19 = mx_df %>%
  filter(marker %in% c("cd19")) %>%
  ggplot() +
  geom_line(stat = "density", aes(marker_value, group = sample_id, color = slide_id), 
            alpha=0.5, linetype = 2) +
    geom_density(aes(marker_value, group = slide_id,
                   color = slide_id), size = 1.25) +
  scale_color_viridis(discrete = TRUE) +
  facet_wrap(~marker, scales = "free", ncol = 1) +
  theme(legend.position = "none") +
  xlim(0, 0.5) +
  labs(x = "marker value")

cd14 / cd19
```


Discordance plots. Show for subset of markers and maybe subset of subjects.

```{r discordance_mxnorm, cache = TRUE}
set.seed(103001)
ids = sample(unique(cell_level_lung$slide_id), 15)

otsu_data = mx_norm$otsu_data %>%
  filter(marker %in% c("cd14", "cd19", "cd8", "cd3", "dapi", "ck"),
         slide_id %in% ids) %>%
  mutate(slide_id = as.numeric(factor(slide_id)),
         norm = factor(table, levels = c("raw", "normalized"))) 

point_size = 2
    

mean_vals = otsu_data %>% 
  group_by(norm, slide_id) %>% 
  summarize(m1 = mean(discordance_score), .groups = "drop")
        

otsu_data %>%
  ggplot() + 
  geom_point(aes(discordance_score, slide_id, color = marker), size = point_size) +
  facet_wrap(~ norm) +
  geom_point(data = mean_vals, aes(m1, slide_id), color = "black", fill = "white", 
             shape = 23, size = point_size) +
  labs(x = "discordance score", y = "slide_id")

```

```{r}
rm(mx_data, mean_vals, otsu_data, discordance_score, ids, markers, point_size, mx_df)
```







## Phenotyping

Add in phenograph plots. Clustering using normalized marker values for a single subject. 


Now using normalized marker values

```{r phenograph_norm, cache = TRUE}
norm_df = mx_norm$norm_data %>%
  filter(slide_id == "#01 0-889-121") %>%
  dplyr::select(cd19, cd3, cd14, cd8, ck, contains("phenotype")) %>%
  mutate(phenotype = case_when(
    phenotype_cd14 == "CD14+" ~ "CD14+",
    phenotype_cd19 == "CD19+" ~ "CD19+",
    phenotype_cd8 == "CD8+" ~ "CD8+",
    phenotype_ck == "CK+" ~ "CK+",
    TRUE ~ "other"
  ))
  

norm_df = na.omit(norm_df)
norm_df_mat = as.matrix(norm_df[, 1:5])


# tsne 
set.seed(234232)
tsne_results = Rtsne(norm_df_mat, dims = 2,check_duplicates = FALSE)
norm_df$tsne1 = tsne_results$Y[,1]  
norm_df$tsne2 = tsne_results$Y[,2]

# phenograph
phen_results = Rphenograph(norm_df_mat, k = 100)
norm_df$phenograph_cluster <- factor(membership(phen_results[[2]]))


```

 Number of clusters normalize is `r length(unique(norm_df$phenograph_cluster))`

Plotted results for unnormalized phenograph labels, normalized phenograph labels, and Inform labels.

```{r phenograph_plot, fig.width = 10}
p1 = norm_df %>%
  ggplot(aes(tsne1, tsne2, color = phenotype)) +
  geom_point(alpha = 0.5, size = 0.75) +
  labs(x = "TSNE 1", y = "TSNE 2", title = "Inform") +
  theme(legend.position = c(.1, .25),
        legend.title = element_blank())

p2 = norm_df %>%
  ggplot(aes(tsne1, tsne2, color = phenograph_cluster)) +
  geom_point(alpha = 0.5, size = 0.75) +
  labs(x = "TSNE 1", y = "", title = "Phenograph") +
  theme(legend.position = "none")

p1 + p2 
```





## References

* [textbook chapter, Wrobel and Vandekar](https://link.springer.com/protocol/10.1007/978-1-0716-2986-4_8)
* [Challenges and Opportunities in the Statistical Analysis of Multiplex Immunofluorescence Data](https://www.mdpi.com/2072-6694/13/12/3031)

### Segmentation

* [Mesmer deep learning based cell segmentation](https://pubmed.ncbi.nlm.nih.gov/34795433/)
* [Two-stage R-CNN](https://www.nature.com/articles/s41598-022-08355-1)
* [Cell Profiler](https://genomebiology.biomedcentral.com/articles/10.1186/gb-2006-7-10-r100)
* [ilastik](https://www.ilastik.org/)
* [Halo (proprietary) software](https://indicalab.com/halo/)
* [inForm (proprietary) software](https://www.akoyabio.com/phenoimager/software/inform-tissue-finder/)

### Phenotyping

* [Astir](https://www.sciencedirect.com/science/article/pii/S2405471221003355)
* [Evaluation of clustering algorithms on Vectra and MIBI data](https://bmcresnotes.biomedcentral.com/articles/10.1186/s13104-022-06097-x)
* [MAUI phenotyping for MIBI images](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1008887)
* [CU-Anschutz pixel-based platform independent phenotyping](https://www.biorxiv.org/content/10.1101/2022.10.20.510630v1.full.pdf)

### Normalization


* [Python-based pipeline](https://www.nature.com/articles/s42003-022-03368-y)
* [mxnorm package](https://joss.theoj.org/papers/10.21105/joss.04180.pdf)
* [Methods behind mxnorm](https://academic.oup.com/bioinformatics/article/38/6/1700/6496920)
